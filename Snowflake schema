
--STEP 1: CREATE SCHEMA based on your unique <teamname> in the FDN_AGAME_DISCOVERY database
USE ROLE COMMUNITY;
USE DATABASE "FDN_AGAME_DISCOVERY";FDN_AGAME_DISCOVERY
CREATE SCHEMA "YOUR_TEAM_NAME";


--STEP 2: Confirm your default Role (COMMUNITY) and Warehouse (COMMUNITY_WH); use the following if necessary
ALTER USER "YOUR.EMAIL@EXXONMOBIL.COM" SET DEFAULT_WAREHOUSE = COMMUNITY_WH DEFAULT_ROLE = "COMMUNITY"


--STEP 3: Get familar with the data available for your quest in data discovery
SELECT * FROM FDN_AGAME_DISCOVERY.DATA_PRODUCTS.COUNTERPARTY LIMIT 100;



--Sales and Purchase information includes masterial description data
SELECT COUNTERPARTY_ID
      ,CP.TYPE
      ,CP.SOURCE_SYSTEM
      ,CP.COUNTRY
      ,CP.VENDOR_CUSTOMER_ID
      ,VENDOR_CUSTOMER_NAME
      ,BUSINESS_ENTITY_ID
      ,BUSINESS_ENTITY_NAME
      ,CASE WHEN CP.TYPE = 'CUSTOMER' THEN SALES.MATERIAL_NUMBER
      		WHEN CP.TYPE = 'VENDOR' THEN PURCH.MATERIAL
            ELSE NULL END AS MATERIAL_NUMBER
      ,CASE WHEN CP.TYPE = 'CUSTOMER' THEN SALES.SALES_ORDER_DESCRIPTION
      		WHEN CP.TYPE = 'VENDOR' THEN MM1.MATERIAL_DESCRIPTION
            ELSE NULL END AS MATERIAL_DESC
      ,SUM(CASE WHEN CP.TYPE = 'CUSTOMER' THEN SALES.NET_VALUE_USD
                WHEN CP.TYPE = 'VENDOR' THEN PURCH.NET_VALUE_USD
                ELSE NULL END) AS TOTAL_USD
FROM FDN_AGAME_DISCOVERY.DATA_PRODUCTS.COUNTERPARTY AS CP
LEFT JOIN FDN_AGAME_DISCOVERY.DATA_PRODUCTS.PURCHASE_ORDER AS PURCH
    ON CP.SOURCE_SYSTEM = PURCH.SOURCE_SYSTEM
    AND CP.VENDOR_CUSTOMER_ID = PURCH.VENDOR
    AND CP.TYPE = 'VENDOR'
LEFT JOIN FDN_AGAME_DISCOVERY.DATA_PRODUCTS.MATERIAL_MASTER AS MM1
	ON MM1.SOURCE_SYSTEM = PURCH.SOURCE_SYSTEM
    AND MM1.MATERIAL = PURCH.MATERIAL
    AND MM1.PLANT = PURCH.PLANT
LEFT JOIN FDN_AGAME_DISCOVERY.DATA_PRODUCTS.SALES_ORDER AS SALES
    ON CP.SOURCE_SYSTEM = SALES.SOURCE_SYSTEM
    AND CP.VENDOR_CUSTOMER_ID = SALES.SOLD_TO_CUSTOMER
    AND CP.TYPE = 'CUSTOMER'
LEFT JOIN FDN_AGAME_DISCOVERY.DATA_PRODUCTS.MATERIAL_MASTER AS MM2
	ON MM2.SOURCE_SYSTEM = SALES.SOURCE_SYSTEM
    AND MM2.MATERIAL = SALES.MATERIAL_CODE_ENTERED
    AND MM2.PLANT = SALES.PLANT  
WHERE CP.SOURCE_SYSTEM NOT IN ('F2','XT')
GROUP BY COUNTERPARTY_ID
     ,CP.TYPE
     ,CP.SOURCE_SYSTEM
     ,CP.COUNTRY
     ,CP.VENDOR_CUSTOMER_ID
     ,VENDOR_CUSTOMER_NAME
     ,BUSINESS_ENTITY_ID
     ,BUSINESS_ENTITY_NAMEFDN_AGAME_DISCOVERY.ML_OTTERS.SALES_SUMMARY
     ,MATERIAL_NUMBER
     ,MATERIAL_DESC
     ,PURCH.MATERIAL;
